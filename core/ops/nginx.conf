server {
  listen 80;
  server_name $DOMAIN;
  location /.well-known/acme-challenge/ { root /var/www/acme; }
  return 301 https://$host$request_uri;
}
server {
  listen 443 ssl http2;
  server_name $DOMAIN;
  ssl_certificate     /etc/nginx/ssl/$DOMAIN/fullchain.cer;
  ssl_certificate_key /etc/nginx/ssl/$DOMAIN/$DOMAIN.key;

  root $SITE_ROOT/current/public;
  add_header Content-Security-Policy "default-src 'self'";

  location /live/ {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_pass http://127.0.0.1:9001;
  }

  location /api/ { proxy_pass http://127.0.0.1:9002; }

  location /media/ {
    types { video/mp4 mp4; application/octet-stream bin; }
    add_header Accept-Ranges bytes;
    try_files $uri =404;
  }
}

